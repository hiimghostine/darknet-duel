version: '3.9'

services:
  db:
    image: mysql:8.0
    container_name: darknet_mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?required}
      - MYSQL_DATABASE=darknet_duel
    command: ["--default-authentication-plugin=mysql_native_password", "--innodb_flush_method=O_DIRECT"]
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - darknet_net

  backend:
    build:
      context: ./backend-server
      dockerfile: Dockerfile
    container_name: darknet_backend
    depends_on:
      db:
        condition: service_healthy
    environment:
      - TZ="Asia/Manila"
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=8000
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=${DB_PASSWORD:?required}
      - DB_NAME=darknet_duel
      - ALLOWED_ORIGINS=${FRONTEND_URL:?required},${BACKEND_URL:?required},${GAME_URL:?required}
      - PUBLIC_URL=${BACKEND_URL:?required}
      - FRONTEND_URL=${FRONTEND_URL:?required}
      - JWT_SECRET=${JWT_SECRET:?required}
      - SERVER_API_KEY=${SERVER_API_KEY:?required}
      - XENDIT_API_KEY=${XENDIT_API_KEY:?required}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    networks:
      - darknet_net

  game_server:
    build:
      context: .
      dockerfile: game-server/Dockerfile
    container_name: darknet_game_server
    depends_on:
      - backend
    environment:
      - NODE_ENV=production
      - GAME_SERVER_HOST=0.0.0.0
      - GAME_SERVER_PORT=8001
      - PUBLIC_SERVER_URL=${GAME_URL:?required}
      - BACKEND_URL=http://backend:8000/api
      - SERVER_API_KEY=${SERVER_API_KEY:?required}
    ports:
      - "${GAME_PORT:-8001}:8001"
    networks:
      - darknet_net

  frontend:
    build:
      context: .
      dockerfile: darknet-duel-frontend/Dockerfile
      args:
        VITE_API_URL: ${BACKEND_URL:?required}/api
        VITE_GAME_SERVER_URL: ${GAME_URL:?required}
        VITE_BUILD_ENV: ${GITHUB_ENVIRONMENT:-dev}
        VITE_COMMIT_SHA: ${GITHUB_SHA:-local}
    container_name: darknet_frontend
    depends_on:
      - backend
      - game_server
    ports:
      - "${FRONTEND_PORT:-8002}:80"
    networks:
      - darknet_net

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: darknet_phpmyadmin
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - PMA_HOST=db
      - PMA_PORT=3306
      - UPLOAD_LIMIT=256M
    ports:
      - "${PHPMYADMIN_PORT:-8003}:80"
    networks:
      - darknet_net

volumes:
  db_data:

networks:
  darknet_net:
    driver: bridge


