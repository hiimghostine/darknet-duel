# Multi-Stage Malware (A305) Wildcard Fix Test

## Issue Description
The Multi-Stage Malware card (A305) was not properly cleaning up its persistent effects when used as a wildcard for stacking. The effect would trigger and grant AP, but then remain active indefinitely.

## Root Causes Fixed

### 1. Player ID Resolution Issue
**Problem**: Persistent effects used BoardGame.io player IDs ('0', '1') but reward application tried to match against `gameState.attacker.id` and `gameState.defender.id`.

**Fix**: Enhanced `applyPersistentReward()` to handle both ID types:
```typescript
// First try exact match with game player IDs
if (effect.playerId === gameState.attacker?.id) {
  isAttacker = true;
  currentPlayer = gameState.attacker;
} else if (effect.playerId === gameState.defender?.id) {
  isAttacker = false;
  currentPlayer = gameState.defender;
} else {
  // Fallback: try BoardGame.io player IDs ('0' = attacker, '1' = defender)
  isAttacker = effect.playerId === '0';
  currentPlayer = isAttacker ? gameState.attacker : gameState.defender;
}
```

### 2. Effect Removal Logic Issue
**Problem**: Effects marked as triggered weren't being properly filtered out when `autoRemove: true`.

**Fix**: Improved filtering logic with better logging:
```typescript
const updatedPersistentEffects = gameState.persistentEffects.map(effect => {
  if (triggeredEffects.includes(effect.sourceCardId)) {
    console.log(`‚úÖ Marking effect from ${effect.sourceCardId} as triggered (autoRemove: ${effect.autoRemove})`);
    return { ...effect, triggered: true };
  }
  return effect;
}).filter(effect => {
  const shouldRemove = effect.triggered && effect.autoRemove;
  if (shouldRemove) {
    console.log(`üóëÔ∏è Removing auto-remove effect from ${effect.sourceCardId} (type: ${effect.type})`);
  }
  return !shouldRemove;
});
```

### 3. State Transition Condition Issue
**Problem**: Effect only triggered on `vulnerable ‚Üí compromised` transitions, but wildcards can be used in various stacking scenarios.

**Fix**: Changed condition to accept any source state:
```typescript
condition: {
  fromState: 'any',  // Accept any source state for wildcards
  toState: 'compromised'
}
```

## Expected Behavior After Fix

1. **Play A305 as wildcard exploit**: Creates persistent effect monitoring infrastructure
2. **Infrastructure becomes compromised**: 
   - Player gains 2 AP immediately
   - Effect is marked as triggered
   - Effect is automatically removed from persistent effects array
3. **Subsequent compromises**: No additional AP gained (effect properly cleaned up)

## Test Scenario

```javascript
// 1. Play A305 Multi-Stage Malware as wildcard exploit on secure infrastructure
// 2. Infrastructure becomes vulnerable (persistent effect waits)
// 3. Infrastructure becomes compromised (effect triggers: +2 AP, then removes itself)
// 4. Verify effect is removed from persistentEffects array
// 5. Additional compromises of same infrastructure should not grant more AP
```

## Verification Points

- [ ] Persistent effect is created when A305 is played as wildcard
- [ ] Effect triggers correctly when infrastructure is compromised
- [ ] Player receives 2 AP as reward
- [ ] Effect is removed from persistentEffects array after triggering
- [ ] No duplicate AP rewards on subsequent compromises
- [ ] Works correctly in both direct play and stacking scenarios

## Code Changes Summary

**Files Modified:**
1. `game-server/src/game/actions/temporaryEffectsManager.ts`
   - Enhanced player ID resolution in `applyPersistentReward()`
   - Improved effect removal logic in `processPersistentEffects()`

2. `game-server/src/game/actions/wildcardResolver.ts`
   - Changed A305 condition from `vulnerable ‚Üí compromised` to `any ‚Üí compromised`
   - Fixed reward amount to use correct value (2 AP)

The fix ensures that Multi-Stage Malware works correctly as both a regular exploit card and as a wildcard in stacking scenarios, with proper cleanup of persistent effects.